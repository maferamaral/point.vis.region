---
trigger: always_on
---

Bounding Box: Insira 4 segmentos representando um retângulo grande ao redor de todo o cenário para garantir que os raios sempre interceptem algo (chamado de "universo" ou "biombo" no PDF).
Linha de Corte (Cut Line): Imagine uma linha horizontal saindo de $x$ para a direita ($0$ radianos).
Identifique segmentos que cruzam esta linha.Estes segmentos formam o conjunto inicial de "Segmentos Ativos" ($S_i$).Atenção: Segmentos que cruzam a linha de corte devem ser tratados com cuidado (podem ser divididos ou inseridos na árvore logo no início).Fase B: Criação e Ordenação de EventosPara cada segmento em $S$, crie dois eventos:Um para o vértice inicial (p1) e outro para o final (p2).Calcule o ângulo polar de cada vértice em relação a $x$ (atan2).Ordenação: Ordene a lista de eventos por ângulo (de $-\pi$ a $+\pi$ ou $0$ a $2\pi$).Desempate: Se dois vértices têm o mesmo ângulo, processe eventos do tipo INICIO antes de FIM (para evitar "buracos" na visibilidade). Se ambos forem INICIO, processe o mais próximo de $x$ primeiro.Fase C: O Loop de Varredura (Sweep Loop)Inicialize a Arvore com os segmentos de $S_i$ (aqueles que já começam interceptando a linha de corte).Itere sobre a lista de eventos ordenada:Atualize o "estado global" do ângulo para a função de comparação da árvore.Identifique o Segmento Mais Próximo (s_prox) consultando o mínimo da Árvore (o nó mais à esquerda).Processar Evento:Se v é INICIO de um segmento s:Insira s na Árvore.Verifique a visibilidade: Se s for inserido antes (mais perto) do atual s_prox, então a visibilidade "muda" para s. Gere um ponto de intersecção no raio atual sobre o antigo s_prox e conecte ao vértice v.Se v é FIM de um segmento s:Se s era o s_prox (o que estava bloqueando a visão), a visibilidade vai "pular" para o próximo segmento na árvore (o sucessor).Gere um ponto de intersecção no raio atual sobre o novo segmento mais próximo.Remova s da Árvore.Fase D: Construção do PolígonoDurante o loop, sempre que o "Segmento Mais Próximo" mudar, adicione os pontos correspondentes à lista de vértices do PoligonoVisibilidade.Adicione o próprio vértice v se ele for visível.Adicione a projeção (intersecção) do raio sobre o segmento mais próximo se a visibilidade for ocultada ou revelada.3. Detalhes Matemáticos para ImplementaçãoO agente deve implementar as seguintes funções auxiliares no módulo geometria:interseccao_raio_segmento(Ponto origem, double angulo, Segmento s):Cria um segmento fictício "infinito" a partir da origem no ângulo dado.Calcula onde este raio bate no segmento s. Retorna o ponto.distancia_ao_centro(Segmento s, Ponto centro, double angulo):Usa a função acima para achar o ponto de intersecção e mede a distância.Isso é usado dentro do comparador da Árvore Binária.4. Tratamento de Casos Especiais (Mencionado no PDF)Colinearidade: Se um segmento é colinear com o raio da bomba (o raio passa "por dentro" da parede), trate o vértice mais distante como o evento relevante para oclusão.Vértices Compartilhados: Se um vértice é fim de um segmento e início de outro, a ordem de processamento (remover um, inserir outro) é crucial para não deixar a árvore vazia momentaneamente.